package org.campagnelab.bdval.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SPropertyOperations;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.io.FileReader;
import java.io.File;
import java.io.BufferedReader;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import jetbrains.mps.baseLanguage.closures.runtime.Wrappers;
import java.util.List;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SConceptOperations;

public class CIDs_Behavior {
  public static void init(SNode thisNode) {
  }

  public static void call_load_4345048909863010217(SNode thisNode) {
    SPropertyOperations.set(thisNode, "numberOfSamples", null);
    ListSequence.fromList(SLinkOperations.getTargets(thisNode, "mismatches", true)).clear();
    try {
      FileReader reader = new FileReader(new File(SPropertyOperations.getString(thisNode, "cidsFileName")));
      BufferedReader datasetReader = new BufferedReader(reader);
      if (datasetReader.readLine().split("\t").length != 2) {
        throw new IllegalArgumentException();
      }
      CIDs_Behavior.call_getCidsEndpts_3367122381605517505(thisNode, datasetReader);
    } catch (Exception e) {
      throw new IllegalArgumentException("Invalid CIDs File");
    }
  }

  public static void call_getCidsEndpts_3367122381605517505(SNode thisNode, BufferedReader cidsTable) {
    try {
      SNode dataSet = SNodeOperations.cast(SNodeOperations.getParent(thisNode), "org.campagnelab.bdval.structure.DataSet");
      ListSequence.fromList(SLinkOperations.getTargets(dataSet, "endpoint", true)).clear();
      int cidsSamples = 0;
      String line;
      String[] lineArray;
      final Wrappers._T<String> id = new Wrappers._T<String>();
      String endpoint;
      List<String> distinctEndpts = ListSequence.fromList(new ArrayList<String>());
      while ((line = cidsTable.readLine()) != null) {
        cidsSamples++;
        lineArray = line.split("\t");
        id.value = lineArray[1];
        SNode matchingId = ListSequence.fromList(SLinkOperations.getTargets(SLinkOperations.getTarget(dataSet, "input", true), "sample", true)).findFirst(new IWhereFilter<SNode>() {
          public boolean accept(SNode sample) {
            return SPropertyOperations.getString(sample, "name").matches(id.value);
          }
        });
        if ((matchingId != null)) {
          endpoint = lineArray[0];
          SPropertyOperations.set(SLinkOperations.getTarget(matchingId, "endpoint", true), "name", endpoint);
          if (!(ListSequence.fromList(distinctEndpts).contains(endpoint))) {
            SNode endptNode = SConceptOperations.createNewNode("org.campagnelab.bdval.structure.Endpoint", null);
            SPropertyOperations.set(endptNode, "name", endpoint);
            ListSequence.fromList(SLinkOperations.getTargets(dataSet, "endpoint", true)).addElement(endptNode);
            ListSequence.fromList(distinctEndpts).addElement(endpoint);
          }
        } else {
          SNode mismatch = SConceptOperations.createNewNode("org.campagnelab.bdval.structure.Sample", null);
          SPropertyOperations.set(mismatch, "name", id.value);
          ListSequence.fromList(SLinkOperations.getTargets(thisNode, "mismatches", true)).addElement(mismatch);
        }
      }
      SPropertyOperations.set(thisNode, "numberOfSamples", "" + (cidsSamples));
    } catch (Exception e) {
      throw new Error();
    }
  }
}
